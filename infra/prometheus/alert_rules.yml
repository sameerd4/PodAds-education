groups:
  - name: podads_alerts
    interval: 30s
    rules:
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(ad_decision_latency_ms_bucket[5m])) > 100
        for: 5m
        labels:
          severity: warning
          service: podads-api
        annotations:
          summary: "High decision latency detected"
          description: "p95 latency is {{ $value | humanize }}ms (threshold: 100ms) for service {{ $labels.service }}"
      
      - alert: CriticalLatency
        expr: histogram_quantile(0.99, rate(ad_decision_latency_ms_bucket[5m])) > 200
        for: 2m
        labels:
          severity: critical
          service: podads-api
        annotations:
          summary: "Critical decision latency detected"
          description: "p99 latency is {{ $value | humanize }}ms (threshold: 200ms) for service {{ $labels.service }}"
      
      - alert: LowFillRate
        expr: (sum(rate(ad_decisions_total{outcome="fill"}[5m])) / sum(rate(ad_decisions_total[5m]))) < 0.80
        for: 5m
        labels:
          severity: warning
          service: podads-api
        annotations:
          summary: "Low fill rate detected"
          description: "Fill rate is {{ $value | humanizePercentage }}% (threshold: 80%)"
      
      - alert: CriticalLowFillRate
        expr: (sum(rate(ad_decisions_total{outcome="fill"}[5m])) / sum(rate(ad_decisions_total[5m]))) < 0.50
        for: 2m
        labels:
          severity: critical
          service: podads-api
        annotations:
          summary: "Critical low fill rate detected"
          description: "Fill rate is {{ $value | humanizePercentage }}% (threshold: 50%)"
      
      - alert: HighErrorRate
        expr: rate(ad_errors_total[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
          service: podads-api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}% (threshold: 1%)"
      
      - alert: CriticalHighErrorRate
        expr: rate(ad_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          service: podads-api
        annotations:
          summary: "Critical high error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}% (threshold: 5%)"
      
      - alert: ServiceDown
        expr: up{job="podads-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: podads-api
        annotations:
          summary: "PodAds API service is down"
          description: "Service {{ $labels.service }} has been down for more than 1 minute"
      
      - alert: NoRequests
        expr: rate(ad_requests_total[10m]) == 0
        for: 10m
        labels:
          severity: warning
          service: podads-api
        annotations:
          summary: "No requests received"
          description: "No ad requests have been received in the last 10 minutes"
